package com.cheddd.activity;

import android.content.DialogInterface;
import android.content.Intent;
import android.support.v7.app.AlertDialog;
import android.support.v7.app.AppCompatActivity;
import android.os.Bundle;
import android.text.Editable;
import android.text.TextUtils;
import android.text.TextWatcher;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.RelativeLayout;
import android.widget.TextView;

import com.bigkoo.pickerview.OptionsPickerView;
import com.cheddd.R;
import com.cheddd.base.MyBaseActivity;
import com.cheddd.bean.ProvinceBean;
import com.cheddd.utils.JsonFileReader;
import com.cheddd.utils.ToastUtil;
import com.cheddd.view.TopNavigationBar;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import java.util.ArrayList;
import java.util.List;

/**
 * 信息认证
 */
public class StatsApproveActivity extends MyBaseActivity implements View.OnClickListener, TextWatcher {

    //姓名，身份证号，手机号码,详细地址
    private EditText mEditTextName, mEditTextIDCard, mEditTextPhone, mEditTextDetalis;
    //联系人，工作信息，居住；
    private RelativeLayout mRelativeHousehold, mRelativeRelation, mRelativeWork, mRelativeLive;
    //提交
    private Button mButtonSubmit;
    //性别，婚姻，教育,省市
    private TextView mTextViewSex, mTextViewMarriage, mTextViewEducation, mTextViewProvince;
    private int position = 0;
    private TopNavigationBar mTnb;
    OptionsPickerView pvOptions;
    //  省份
    ArrayList<ProvinceBean> provinceBeanList = new ArrayList<>();
    //  城市
    ArrayList<String> cities;
    ArrayList<List<String>> cityList = new ArrayList<>();
    //  区/县
    ArrayList<String> district;
    ArrayList<List<String>> districts;
    ArrayList<List<List<String>>> districtList = new ArrayList<>();


    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_stats_approve);
        initView();
        initData();
        setListener();
    }

    private void initData() {
        pvOptions = new OptionsPickerView(this);
    }


    private void setListener() {
        mTextViewProvince.addTextChangedListener(this);
        mTextViewEducation.addTextChangedListener(this);
        mTextViewMarriage.addTextChangedListener(this);
        mTextViewSex.addTextChangedListener(this);
        mEditTextPhone.addTextChangedListener(this);
        mEditTextIDCard.addTextChangedListener(this);
        mEditTextName.addTextChangedListener(this);
        mEditTextDetalis.addTextChangedListener(this);
        mButtonSubmit.setOnClickListener(this);
        mTextViewSex.setOnClickListener(this);
        mRelativeHousehold.setOnClickListener(this);
        mTextViewMarriage.setOnClickListener(this);
        mTextViewEducation.setOnClickListener(this);
        mTextViewMarriage.setOnClickListener(this);
        mRelativeWork.setOnClickListener(this);
        mRelativeRelation.setOnClickListener(this);
        mRelativeLive.setOnClickListener(this);
        mTextViewProvince.setOnClickListener(this);
        mTnb.setOnBackListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                finish();
            }
        });
    }

    private void initView() {
        mTnb = (TopNavigationBar) findViewById(R.id.tnb_stats);
        mButtonSubmit = (Button) findViewById(R.id.bt_stats_input);
        mEditTextDetalis = (EditText) findViewById(R.id.et_stats_details);
        mEditTextIDCard = (EditText) findViewById(R.id.et_stats_IDCard);
        mEditTextPhone = (EditText) findViewById(R.id.et_stats_phone);
        mEditTextName = (EditText) findViewById(R.id.et_stats_name);
        mRelativeHousehold = (RelativeLayout) findViewById(R.id.rl_stats_household);
        mRelativeRelation = (RelativeLayout) findViewById(R.id.rl_stats_relation);
        mRelativeLive = (RelativeLayout) findViewById(R.id.rl_stats_live);
        mRelativeWork = (RelativeLayout) findViewById(R.id.rl_stats_work);
        mTextViewSex = (TextView) findViewById(R.id.tv_stats_sex);
        mTextViewEducation = (TextView) findViewById(R.id.tv_stats_educations);
        mTextViewMarriage = (TextView) findViewById(R.id.tv_stats_marriage);
        mTextViewProvince = (TextView) findViewById(R.id.tv_stats_household);

    }

    @Override
    public void onClick(View v) {
        if (v != null) {
            switch (v.getId()) {
                //提交
                case R.id.bt_stats_input:
                    submit();
                    break;
                //性别
                case R.id.tv_stats_sex:
                    change_sex();
                    break;

                case R.id.rl_stats_household:
                    break;
                //学历
                case R.id.tv_stats_educations:
                    education();
                    break;
                //婚姻
                case R.id.tv_stats_marriage:
                    marriage();
                    break;
                //工作
                case R.id.rl_stats_work:
                    Intent intent = new Intent(StatsApproveActivity.this, WorkActivity.class);
                    startActivity(intent);
                    break;
                //联系人
                case R.id.rl_stats_relation:
                    startActivity(new Intent(StatsApproveActivity.this, RelationActivity.class));
                    break;
                //居住
                case R.id.rl_stats_live:
                    startActivity(new Intent(StatsApproveActivity.this, LiveActivity.class));
                    break;
                case R.id.tv_stats_household:
                    province();
                    break;
            }
        }
    }

    private void province() {
        String province_data_json = JsonFileReader.getJson(this, "province_data.json");
        //  解析json数据
        parseJson(province_data_json);

        //  设置三级联动效果
        pvOptions.setPicker(provinceBeanList, cityList, districtList, true);
        pvOptions.setCyclic(false, false, false);
        // 设置默认选中的三级项目
        pvOptions.setSelectOptions(0, 0, 0);
        //  监听确定选择按钮
        pvOptions.setOnoptionsSelectListener(new OptionsPickerView.OnOptionsSelectListener() {
            @Override
            public void onOptionsSelect(int options1, int option2, int options3) {
                //返回的分别是三个级别的选中位置
                String city = provinceBeanList.get(options1).getPickerViewText();
                String address;
                //  如果是直辖市或者特别行政区只设置市和区/县
                if ("北京市".equals(city) || "上海市".equals(city) || "天津市".equals(city) || "重庆市".equals(city) || "澳门".equals(city) || "香港".equals(city)) {
                    address = provinceBeanList.get(options1).getPickerViewText()
                            + " " + districtList.get(options1).get(option2).get(options3);
                } else {
                    address = provinceBeanList.get(options1).getPickerViewText()
                            + " " + cityList.get(options1).get(option2)
                            + " " + districtList.get(options1).get(option2).get(options3);
                }
                mTextViewProvince.setText(address);
            }
        });


        //  点击弹出选项选择器
        mTextViewProvince.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                pvOptions.show();
            }
        });
    }

    public void parseJson(String str) {
        try {
            //  获取json中的数组
            JSONArray jsonArray = new JSONArray(str);
            //  遍历数据组
            for (int i = 0; i < jsonArray.length(); i++) {
                //  获取省份的对象
                JSONObject provinceObject = jsonArray.optJSONObject(i);
                //  获取省份名称放入集合
                String provinceName = provinceObject.getString("name");
                provinceBeanList.add(new ProvinceBean(provinceName));
                //  获取城市数组
                JSONArray cityArray = provinceObject.optJSONArray("city");
                cities = new ArrayList<>();//   声明存放城市的集合
                districts = new ArrayList<>();//声明存放区县集合的集合
                //  遍历城市数组
                for (int j = 0; j < cityArray.length(); j++) {
                    //  获取城市对象
                    JSONObject cityObject = cityArray.optJSONObject(j);
                    //  将城市放入集合
                    String cityName = cityObject.optString("name");
                    cities.add(cityName);
                    district = new ArrayList<>();// 声明存放区县的集合
                    //  获取区县的数组
                    JSONArray areaArray = cityObject.optJSONArray("area");
                    //  遍历区县数组，获取到区县名称并放入集合
                    for (int k = 0; k < areaArray.length(); k++) {
                        String areaName = areaArray.getString(k);
                        district.add(areaName);
                    }
                    //  将区县的集合放入集合
                    districts.add(district);
                }
                //  将存放区县集合的集合放入集合
                districtList.add(districts);
                //  将存放城市的集合放入集合
                cityList.add(cities);
            }
        } catch (JSONException e) {
            e.printStackTrace();
        }
    }

    //婚姻状况
    private void marriage() {
        final AlertDialog.Builder builder = new AlertDialog.Builder(this);
        builder.setSingleChoiceItems(R.array.marriage, position, new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
                position = which;
                final String[] aryShop = getResources().getStringArray(R.array.marriage);
                mTextViewMarriage.setText(aryShop[which]);
                dialog.dismiss();
            }
        }).create().show();
    }

    //学历
    private void education() {
        final AlertDialog.Builder builder = new AlertDialog.Builder(this);
        builder.setSingleChoiceItems(R.array.education, position, new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
                position = which;
                final String[] aryShop = getResources().getStringArray(R.array.education);
                mTextViewEducation.setText(aryShop[which]);
                dialog.dismiss();
            }
        }).create().show();

    }

    //性别的选择
    private void change_sex() {
        final AlertDialog.Builder builder = new AlertDialog.Builder(this);
        builder.setSingleChoiceItems(R.array.sex, position, new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
                position = which;
                final String[] aryShop = getResources().getStringArray(R.array.sex);
                mTextViewSex.setText(aryShop[which]);
                dialog.dismiss();
            }
        }).create().show();

    }


    //提交的界面
    private void submit() {
        //用户名
        String name = mEditTextName.getText().toString().trim();
        String nameRegular = "[\u4E00-\u9FA5]{2,5}(?:·[\u4E00-\u9FA5]{2,5})*";
        if (!name.matches(nameRegular)) {
            ToastUtil.show(this, "姓名格式错误");
            return;
        }
        //身份证号码的判断
        String IdCard = mEditTextIDCard.getText().toString().trim();
        if (!IdCard.matches("/^[1-9]\\d{5}[1-9]\\d{3}((0\\d)|(1[0-2]))(([0|1|2]\\d)|3[0-1])\\d{3}([0-9]|X)$/")) {
            ToastUtil.show(this, "身份证格式错误");
            return;
        }
        //手机号码
        String phone = mEditTextPhone.getText().toString().trim();
        if (!phone.matches("1\\d{10}")) {
            ToastUtil.show(this, "手机格式错误");
            return;
        }
        finish();
    }

    @Override
    public void beforeTextChanged(CharSequence s, int start, int count, int after) {

    }

    @Override
    public void onTextChanged(CharSequence s, int start, int before, int count) {
        if (mEditTextIDCard.getSelectionEnd() == 18) {
            mEditTextPhone.requestFocus();
        }
        if (mEditTextPhone.getText().toString().trim().length() >= 11) {
            mEditTextPhone.setCursorVisible(false);
        }
    }

    @Override
    public void afterTextChanged(Editable s) {
       /* if (mEditTextName.getText().toString().length() > 0)
            if (mEditTextIDCard.getText().toString().length() > 0)
                if (mEditTextPhone.getText().toString().length() > 0)
                    if (mEditTextDetalis.getText().toString().length() > 0)
                        if (mTextViewProvince.getText().toString().length() > 0)
                            if (mTextViewSex.getText().toString().length() > 0)
                                if (mTextViewMarriage.getText().toString().length() > 0)
                                    if (mTextViewEducation.getText().toString().length() > 0) {
                                        mButtonSubmit.setEnabled(true);
                                    } else {
                                        mButtonSubmit.setEnabled(false);
                                    }*/
        if (mEditTextName.getText().toString().trim().length() >1) {
            if (mEditTextPhone.getSelectionEnd() == 11) {
                if (mEditTextIDCard.getSelectionEnd() == 18) {
                    if (mEditTextDetalis.getText().toString().trim().length() > 3) {
                        mButtonSubmit.setEnabled(true);
                    }
                } else {
                    mButtonSubmit.setEnabled(false);
                }
            } else {
                mButtonSubmit.setEnabled(false);
            }
        } else {
            mButtonSubmit.setEnabled(false);
        }

    }
}
