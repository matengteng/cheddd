package com.cheddd.fragment;

import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.support.annotation.Nullable;
import android.support.v4.view.ViewPager;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.RelativeLayout;
import android.widget.TextView;
import android.widget.Toast;

import com.cheddd.R;
import com.cheddd.activity.BankApproveActivity;
import com.cheddd.activity.CarApproveActivity;
import com.cheddd.activity.ExtremeMortageActivity;
import com.cheddd.activity.LiveActivity;
import com.cheddd.activity.LoginActivity;
import com.cheddd.activity.PettyLoanActivity;
import com.cheddd.activity.PhoneApproveActivity;
import com.cheddd.activity.PledgeActivity;
import com.cheddd.activity.StatsApproveActivity;
import com.cheddd.adapter.IndexHeaderAdapter;
import com.cheddd.application.MyApplications;
import com.cheddd.asynctask.NetTask;
import com.cheddd.base.BaseFragment;
import com.cheddd.bean.Account;
import com.cheddd.config.NetConfig;
import com.cheddd.parse.IndexParse;
import com.cheddd.utils.LoginTokenUtils;
import com.cheddd.utils.OkhttpUtils;
import com.cheddd.utils.SdCardUtils;
import com.cheddd.utils.ToastUtil;
import com.cheddd.view.LooperTextView;
import com.cheddd.view.TopNavigationBar;
import com.squareup.picasso.Picasso;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import okhttp3.FormBody;
import okhttp3.Request;


/**
 * Created by Administrator on 2017/5/18 0018.
 * 首页的界面
 */

public class IndexFragment extends BaseFragment implements View.OnClickListener {
    private static String TAG = InfoFragment.class.getSimpleName();
    private TopNavigationBar mTnb;
    private LooperTextView looperview;
    private RelativeLayout mRelativePetty, mRelativeExtreme;
    private TextView mSlideTextView, mRollTextView;
    private Context mContent;
    private String path = "http://chanyouji.com/api/trips/featured.json?page=2";
    private ViewPager mViewPage;
    private LinearLayout mRound;
    private TextView mTextViewtitle;
    private List<Account> mAccount;
    private List<String> mTitle;
    private List<ImageView> mImageView;
    private IndexHeaderAdapter mAdapter;
    // 自动循环 标记 当当前Activity 销毁 停止循环
    private boolean isStop = true;
    // 记录是否有重复添加页卡
    private boolean isAdd = false;
    // 记录当前的dot 位置 作为下一次滑动的改变值
    private int currentIntex;
    private ImageView mView;
    private Handler mHandler = new Handler() {
        @Override
        public void handleMessage(Message msg) {
            super.handleMessage(msg);
            mViewPage.setCurrentItem(mViewPage.getCurrentItem() + 1);
            mHandler.sendEmptyMessageDelayed(0, 3000);
        }
    };
    private List<String> mNotice;


    @Nullable
    @Override
    public View onCreateView(LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {
        View view = LayoutInflater.from(getContext()).inflate(R.layout.fragment_index, null);
        mContent = getActivity();
        initView(view);
        initData();
        setData();
        setListener();
        return view;
    }

    @Override
    public void onDestroy() {
        super.onDestroy();
        isStop = false;
    }

    private void setData() {
        mViewPage.setAdapter(mAdapter);
        if (mAccount.size() != 0) {
            int current = Integer.MAX_VALUE / 2 - Integer.MAX_VALUE / 2 % mAccount.size();
            mViewPage.setCurrentItem(current);
            mRound.getChildAt(0).setEnabled(true);
            //  mTextViewtitle.setText(mAccount.get(0).getName());
            mHandler.sendEmptyMessageDelayed(0, 3000);
        } else {
            return;
        }
    }

    private void setListener() {
        mRelativeExtreme.setOnClickListener(this);
        mRelativePetty.setOnClickListener(this);
        mViewPage.addOnPageChangeListener(new ViewPager.OnPageChangeListener() {
            @Override
            public void onPageScrolled(int position, float positionOffset, int positionOffsetPixels) {

            }

            @Override
            public void onPageSelected(int position) {
                if (isAdd) {
                    //   mTextViewtitle.setText(mAccount.get(position % mAccount.size()).getName());
                    mRound.getChildAt(position % (mImageView.size() / 2)).setEnabled(true);
                    mRound.getChildAt(currentIntex).setEnabled(false);
                    currentIntex = position % (mAccount.size() / 2);
                } else {
                    //  mTextViewtitle.setText(mAccount.get(position % mAccount.size()).getName());
                    mRound.getChildAt(position % (mImageView.size())).setEnabled(true);
                    mRound.getChildAt(currentIntex).setEnabled(false);
                    currentIntex = position % (mAccount.size());
                }

            }


            @Override
            public void onPageScrollStateChanged(int state) {

            }
        });
        new Thread(new Runnable() {
            @Override
            public void run() {
                mHandler.sendEmptyMessageDelayed(0, 3000);
            }
        }).start();
    }

    private void initData() {
        mTnb.setBackVisibility(false);
        looperview.setTipList(generateTips());
        mTitle = new ArrayList<>();
        mImageView = new ArrayList<>();
        mAccount = new ArrayList<>();
        if (SdCardUtils.netWorkConnected(mContent)) {
            initNet();
        } else {

        }
    }

    //有网络的时候加载
    private void initNet() {
        new NetTask() {
            @Override
            public List<String> onCallBack(String result) {
                if (result != null) {
                    SdCardUtils.saveJsonToSD(result, NetConfig.NOTICE, mContent);
                }
                List<String> list = new ArrayList<String>();
                try {
                    JSONArray array = new JSONArray(result);
                    for (int i = 0; i < array.length(); i++) {
                        JSONObject obj = array.getJSONObject(i);
                        JSONObject object = obj.getJSONObject("user");
                        String image = object.getString("image");
                        String name = object.getString("name");
                        Account account = new Account(name, image);
                        mAccount.add(account);
                    }
                    intRound();
                    if (mAccount.size() < 4) {
                        isAdd = true;
                        for (int i = 0; i < mAccount.size() * 2; i++) {
                            ViewPager.LayoutParams params = new ViewPager.LayoutParams();
                            params.height = ViewPager.LayoutParams.MATCH_PARENT;
                            params.width = ViewPager.LayoutParams.MATCH_PARENT;
                            mView = new ImageView(mContent);
                            //设置图片充满imageView中
                            mView.setScaleType(ImageView.ScaleType.FIT_XY);
                            Picasso.with(mContent).load(mAccount.get(i % mAccount.size()).getImage()).into(mView);
                            mImageView.add(mView);
                        }
                    } else {
                        isAdd = false;
                        for (int i = 0; i < mAccount.size(); i++) {
                            ViewPager.LayoutParams params = new ViewPager.LayoutParams();
                            params.height = ViewPager.LayoutParams.MATCH_PARENT;
                            params.width = ViewPager.LayoutParams.MATCH_PARENT;
                            mView = new ImageView(mContent);
                            //设置图片充满imageView中
                            mView.setScaleType(ImageView.ScaleType.FIT_XY);
                            Picasso.with(mContent).load(mAccount.get(i).getImage()).into(mView);
                            mImageView.add(mView);
                        }
                    }

                    mAdapter.notifyDataSetChanged();

                } catch (JSONException e) {
                    e.printStackTrace();
                }

                return list;
            }

        }.execute(path);

        mAdapter = new IndexHeaderAdapter(mImageView);
    }

    //底部的小圆
    private void intRound() {
        for (int i = 0; i < mAccount.size(); i++) {
            View dot = new View(mContent);
            LinearLayout.LayoutParams lp = new LinearLayout.LayoutParams(20, 20);
            dot.setBackgroundResource(R.drawable.viewpage_round);
            dot.setLayoutParams(lp);
            dot.setEnabled(false);
            mRound.addView(dot);

        }
    }

    //消息滚动条
    private List<String> generateTips() {
        mNotice = new ArrayList<>();
        if (SdCardUtils.netWorkConnected(mContent)) {
            initNetNotice();
        } else {
            initJsonNotice();
        }
        return mNotice;
    }

    //没有网络的情况下加载滚动条的消息
    private void initJsonNotice() {
        String jsonToSD = SdCardUtils.getJsonToSD(NetConfig.NOTICE, mContent);
        if (jsonToSD != null) {
            List<String> notice = IndexParse.getNotice(jsonToSD);
            mNotice.addAll(notice);
        }

    }

    //有网的情况下加载滚动条的消息
    private void initNetNotice() {
        FormBody formBody = new FormBody.Builder().build();
        OkhttpUtils.getInstance(getContext()).asyncPost(NetConfig.NOTICE, formBody, new OkhttpUtils.HttpCallBack() {
            @Override
            public void onError(Request request, IOException e) {
            }

            @Override
            public void onSuccess(Request request, String result) {
                Log.d("TAG", result);
                if (result != null) {
                    SdCardUtils.saveJsonToSD(result, NetConfig.NOTICE, mContent);
                    List<String> notice = IndexParse.getNotice(result);
                    mNotice.addAll(notice);
                }
            }
        });

    }

    //加载控件
    private void initView(View view) {
        mTnb = (TopNavigationBar) view.findViewById(R.id.tnb_index);
        looperview = (LooperTextView) view.findViewById(R.id.ltv_index_slide);
        mRelativePetty = (RelativeLayout) view.findViewById(R.id.rl_index_petty);
        mRelativeExtreme = (RelativeLayout) view.findViewById(R.id.rl_index_extreme);
        mViewPage = (ViewPager) view.findViewById(R.id.vp_index_head);
        mTextViewtitle = (TextView) view.findViewById(R.id.tv_index_text);
        mRound = (LinearLayout) view.findViewById(R.id.ll_index_round);
    }

    //对点击事件的处理
    @Override
    public void onClick(View view) {
        if (view != null) {
            switch (view.getId()) {
                case R.id.rl_index_petty:
                    //小额贷款
                    indexPetty();
                    break;
                case R.id.rl_index_extreme:
                    //极速抵押
                    extremeMoreage();
                    break;
            }
        }
    }

    //小额借款
    private void indexPetty() {
        final String json = LoginTokenUtils.getJson();
        FormBody formbody = new FormBody.Builder().add("content", json).build();
        OkhttpUtils.getInstance(mContent).asyncPost(NetConfig.INDEX_PETTYLOAN_INFO, formbody, new OkhttpUtils.HttpCallBack() {
            @Override
            public void onError(Request request, IOException e) {

            }

            @Override
            public void onSuccess(Request request, String result) {
                if (result != null) {
                    Log.d(TAG, "获取可借额度和总额度，还款试算" + result);
                    Log.d(TAG, "onSuccess:" + NetConfig.INDEX_PETTYLOAN_INFO + "content" + "=" + json);
                    try {
                        JSONObject object = new JSONObject(result);
                        String returnCode = object.getString("returnCode");
                        String returnMsg = object.getString("returnMsg");
                        if ("000000".equals(returnCode)) {
                            mContent.startActivity(new Intent(getActivity(), PettyLoanActivity.class));
                        } else if ("0017".equals(returnCode)) {
                            mContent.startActivity(new Intent(getActivity(), LoginActivity.class));
                            ToastUtil.show(mContent, returnMsg);
                        } else {
                            return;
                        }
                    } catch (JSONException e) {
                        e.printStackTrace();
                    }
                }

            }
        });
    }

    //极速抵押
    private void extremeMoreage() {
        String json = LoginTokenUtils.getJson();
        FormBody formBody = new FormBody.Builder().add("content", json).build();
        OkhttpUtils.getInstance(getActivity()).asyncPost(NetConfig.OAUTH_SETP, formBody, new OkhttpUtils.HttpCallBack() {
            @Override
            public void onError(Request request, IOException e) {

            }

            @Override
            public void onSuccess(Request request, String result) {
                if (result != null) {
                    // Log.d(TAG, "进度" + result);
                    try {
                        JSONObject object = new JSONObject(result);
                        String returnCode = object.getString("returnCode");
                        String returnMsg = object.getString("returnMsg");
                        if ("0017".equals(returnCode)) {
                            ToastUtil.show(mContent, returnMsg);
                            startActivity(new Intent(mContent, LoginActivity.class));
                            return;
                        }
                        int phoneAuth = object.getInt("phoneAuth");
                        int carInfoAuth = object.getInt("carInfoAuth");
                        int bankInfoAuth = object.getInt("bankInfoAuth");
                        int personalAuth = object.getInt("personalAuth");
                        int loanInitAud = object.getInt("loanInitAud");
                        if (phoneAuth == 0) {
                            if (personalAuth == 0) {
                                if (carInfoAuth == 0) {
                                    if (bankInfoAuth == 0) {
                                        if (loanInitAud == 1) {
                                            getActivity().startActivity(new Intent(mContent, ExtremeMortageActivity.class));
                                        } else {
                                            getActivity().startActivity(new Intent(mContent, PledgeActivity.class));
                                        }
                                    } else {
                                        ToastUtil.show(mContent, "银行认证未通过");
                                        mContent.startActivity(new Intent(mContent, BankApproveActivity.class));

                                    }
                                } else {
                                    ToastUtil.show(mContent, "车辆认证未通过");
                                    mContent.startActivity(new Intent(mContent, CarApproveActivity.class));

                                }
                            } else {
                                ToastUtil.show(mContent, "个人信息未通过");
                                mContent.startActivity(new Intent(mContent, StatsApproveActivity.class));

                            }
                        } else {
                            ToastUtil.show(mContent, "手机认证未通过");
                            mContent.startActivity(new Intent(mContent, PhoneApproveActivity.class));
                        }
                    } catch (JSONException e) {
                        e.printStackTrace();
                    }
                }
            }
        });
    }

}
