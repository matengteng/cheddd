package com.cheddd.activity;

import android.Manifest;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.net.Uri;
import android.provider.Settings;
import android.support.v4.app.ActivityCompat;
import android.support.v4.content.ContextCompat;
import android.support.v7.app.AlertDialog;
import android.os.Bundle;
import android.text.Editable;
import android.text.TextUtils;
import android.text.TextWatcher;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.TextView;
import android.widget.Toast;

import com.cheddd.R;
import com.cheddd.application.MyApplications;
import com.cheddd.base.MyBaseActivity;
import com.cheddd.bean.InfoRelation;
import com.cheddd.config.NetConfig;
import com.cheddd.utils.LoginTokenUtils;
import com.cheddd.utils.OkhttpUtils;
import com.cheddd.utils.ToastUtil;
import com.cheddd.view.TopNavigationBar;
import com.google.gson.Gson;

import org.json.JSONException;
import org.json.JSONObject;

import java.io.IOException;
import java.util.LinkedHashMap;
import java.util.Map;

import okhttp3.FormBody;
import okhttp3.Request;

/*
联系人界面
*/
public class RelationActivity extends MyBaseActivity implements View.OnClickListener, TextWatcher {

    private static String TAG = RegisterActivity.class.getSimpleName();
    private Map<String, Integer> map = new LinkedHashMap<>();
    private ImageView mImageView, mImageViewPhone;//打电话、紧急联系人打电话
    private LinearLayout mLayout, mLayout2, mLayout3;
    //增加、提交
    private Button mButtonAdd, mButtonSubmit;
    private TopNavigationBar mTnb;
    //关系
    private TextView mTextViewRelation;
    //直系 姓名，手机号码；紧急姓名，手机号码
    private EditText mEditTextName, mEditTextPhone, mEditTextUrgencyPhone, mEditTextrgencyName;

    private int position;
    private int mCount = 0;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_relation);
        initView();
        initData();
        setData();
        setListener();
        mLayout.addView(addView1());
    }

    private void initData() {
        String json = LoginTokenUtils.getJson();
        FormBody formBody = new FormBody.Builder().add("content", json).build();
        OkhttpUtils.getInstance(this).asyncPost(NetConfig.INFO_RELATION_INFO, formBody, new OkhttpUtils.HttpCallBack() {
            @Override
            public void onError(Request request, IOException e) {

            }

            @Override
            public void onSuccess(Request request, String result) {
                if (result != null) {
                    Log.d(TAG, "获取联系人：" + result);

                }
            }
        });
    }

    private void setData() {

    }

    private void setListener() {

        mEditTextUrgencyPhone.addTextChangedListener(this);
        mEditTextrgencyName.addTextChangedListener(this);
        mButtonSubmit.setOnClickListener(this);
        mImageViewPhone.setOnClickListener(this);
        mButtonAdd.setOnClickListener(this);
        mButtonSubmit.setOnClickListener(this);
        mTnb.setOnBackListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if (v != null) {
                    finish();
                }
            }
        });
    }

    private void initView() {

        mTnb = (TopNavigationBar) findViewById(R.id.tnb_relation);
        mImageViewPhone = (ImageView) findViewById(R.id.iv_relation_urgency_phone);
        mEditTextrgencyName = (EditText) findViewById(R.id.et_relation_urgency_name);
        mEditTextUrgencyPhone = (EditText) findViewById(R.id.et_relation_regency_phone);
        mLayout = (LinearLayout) findViewById(R.id.ll_relation_container1);
        mButtonAdd = (Button) findViewById(R.id.bt_relation_add);
        mButtonSubmit = (Button) findViewById(R.id.bt_relation_submit);
    }

    @Override
    public void onClick(View v) {
        if (v != null) {
            switch (v.getId()) {
                case R.id.iv_relation_cellPhone:
                    cellPhone();
                    break;
                case R.id.bt_relation_add:
                    mCount++;
                    addView();
                    if (mCount == 2) {
                        mButtonAdd.setEnabled(false);
                        ToastUtil.show(this,"最多能添加两个两个");
                    }
                    break;
                case R.id.tv_relation_relation:
                    relation();
                    break;
                case R.id.bt_relation_submit:
                    submit();
                    break;
            }
        }
    }

    //拨打电话
    private void cellPhone() {
        if (ContextCompat.checkSelfPermission(RelationActivity.this, Manifest.permission.CALL_PHONE) != PackageManager.PERMISSION_GRANTED) {
            if (ActivityCompat.shouldShowRequestPermissionRationale(RelationActivity.this, Manifest.permission.CALL_PHONE)) {
                Intent intent = new Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS);
                Uri uri = Uri.fromParts("package", getPackageName(), null);
                intent.setData(uri);
                startActivity(intent);
            } else {
                ActivityCompat.requestPermissions(RelationActivity.this, new String[]{Manifest.permission.CALL_PHONE}, 100);
            }
        } else {
            CallPhone();
        }

    }


    private void CallPhone() {
        String number = mEditTextUrgencyPhone.getText().toString().trim();
        if (TextUtils.isEmpty(number)) {
            Toast.makeText(RelationActivity.this, "号码不能为空！", Toast.LENGTH_SHORT).show();
        } else {
            Intent intent = new Intent();
            intent.setAction(Intent.ACTION_CALL);
            Uri data = Uri.parse("tel:" + number);
            intent.setData(data);
            startActivity(intent);
        }
    }

    // 处理权限申请的回调
    @Override
    public void onRequestPermissionsResult(int requestCode, String[] permissions, int[] grantResults) {
        switch (requestCode) {
            case 100: {
                if (grantResults.length > 0
                        && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
                    // 授权成功，继续打电话
                    CallPhone();
                    cellPhoneurgency();
                } else {
                    // 授权失败！
                    Toast.makeText(this, "授权失败！", Toast.LENGTH_LONG).show();
                }
                break;
            }
        }
    }


    //点击提交时
    private void submit() {
        String name = mEditTextName.getText().toString().trim();
        //用户名
        String nameRegular = "[\u4E00-\u9FA5]{2,5}(?:·[\u4E00-\u9FA5]{2,5})*";
        if (!name.matches(nameRegular)) {
            ToastUtil.show(this, "姓名格式错误");
            return;
        }
        String phone = mEditTextPhone.getText().toString().trim();
        if (!phone.matches("1\\d{10}")) {
            ToastUtil.show(this, "手机格式错误");
            return;
        }
        String gencyName = mEditTextrgencyName.getText().toString().trim();
        if (!gencyName.matches(nameRegular)) {
            ToastUtil.show(this, "姓名格式错误");
            return;
        }
        String urgencyphone = mEditTextUrgencyPhone.getText().toString().trim();
        if (!urgencyphone.matches("1\\d{10}")) {
            ToastUtil.show(this, "手机格式错误");
            return;
        }
        final InfoRelation relation = new InfoRelation();
        //客户端来源、用户令牌、直系亲属人编号、直系亲属姓名、直系亲属手机号、直系亲属关系、紧急联系人编号、紧急联系人姓名、紧急联系人
        relation.setClientType("2");
        relation.setToken(MyApplications.getToken());
        relation.setId("");
        relation.setContractName(mEditTextName.getText().toString().trim());
        relation.setTelNo(mEditTextPhone.getText().toString().trim());
        relation.setUrgentId("1");
        relation.setUrgentContractName(mEditTextrgencyName.getText().toString().trim());
        relation.setUrgentTelNo(mEditTextUrgencyPhone.getText().toString().trim());
        for (Integer key : map.values()) {
            relation.setRelation(new Integer(key).toString());
        }
        Gson gson = new Gson();
        String json = gson.toJson(relation);
        Log.d(TAG, json);
        FormBody formbody = new FormBody.Builder().add("content", json).build();
        OkhttpUtils.getInstance(this).asyncPost(NetConfig.INFO_RELATION, formbody, new OkhttpUtils.HttpCallBack() {
            @Override
            public void onError(Request request, IOException e) {

            }

            @Override
            public void onSuccess(Request request, String result) {
                if (relation != null) {
                    try {
                        Log.d(TAG, "提交联系人:" + result);
                        JSONObject object = new JSONObject(result);
                        String returnCode = object.getString("returnCode");
                        String returnMsg = object.getString("returnMsg");
                        if ("000000".equals(returnCode)) {
                            ToastUtil.show(RelationActivity.this, returnMsg);
                            finish();
                        }
                        if ("0017".equals(returnCode)) {
                            startActivity(new Intent(RelationActivity.this, LoginActivity.class));
                            ToastUtil.show(RelationActivity.this, returnMsg);
                            finish();
                        }
                    } catch (JSONException e) {
                        e.printStackTrace();
                    }
                }
            }
        });
    }

    private void relation() {
        final AlertDialog.Builder builder = new AlertDialog.Builder(this);
        builder.setSingleChoiceItems(R.array.relation, position, new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
                position = which;
                final String[] aryShop = getResources().getStringArray(R.array.relation);
                map.put(aryShop[which], which + 1);
                mTextViewRelation.setText(aryShop[which]);
                dialog.dismiss();
            }
        }).create().show();

    }

    private View addView1() {
        LinearLayout.LayoutParams lp = new LinearLayout.LayoutParams(LinearLayout.LayoutParams.MATCH_PARENT, LinearLayout.LayoutParams.WRAP_CONTENT);
        View view = LayoutInflater.from(this).inflate(R.layout.relation_emergency, null);
        view.setLayoutParams(lp);
        mEditTextName = (EditText) view.findViewById(R.id.et_relation_name);
        mImageView = (ImageView) view.findViewById(R.id.iv_relation_cellPhone);
        mEditTextPhone = (EditText) view.findViewById(R.id.et_relation_phone);
        mTextViewRelation = (TextView) view.findViewById(R.id.tv_relation_relation);
        initEmergency();
        return view;
    }

    //增加view的视图
    private void addView() {
        View view = LayoutInflater.from(this).inflate(R.layout.relation_emergency, null);
        mEditTextName = (EditText) view.findViewById(R.id.et_relation_name);
        mImageView = (ImageView) view.findViewById(R.id.iv_relation_cellPhone);
        mEditTextPhone = (EditText) view.findViewById(R.id.et_relation_phone);
        mTextViewRelation = (TextView) view.findViewById(R.id.tv_relation_relation);
        initEmergency();
        mLayout.addView(view);
    }

    //联系人拨打电话
    private void initEmergency() {
        mEditTextPhone.addTextChangedListener(this);
        mEditTextName.addTextChangedListener(this);
        mTextViewRelation.addTextChangedListener(this);
        mTextViewRelation.setOnClickListener(this);
        mImageView.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                cellPhoneurgency();
            }
        });
    }

    private void cellPhoneurgency() {
        String number = mEditTextPhone.getText().toString().trim();
        if (TextUtils.isEmpty(number)) {
            Toast.makeText(RelationActivity.this, "号码不能为空！", Toast.LENGTH_SHORT).show();
        } else {
            Intent intent = new Intent();
            intent.setAction(Intent.ACTION_CALL);
            Uri data = Uri.parse("tel:" + number);
            intent.setData(data);
            startActivity(intent);
        }
    }

    @Override
    public void beforeTextChanged(CharSequence s, int start, int count, int after) {

    }

    @Override
    public void onTextChanged(CharSequence s, int start, int before, int count) {

    }

    @Override
    public void afterTextChanged(Editable s) {
        if (mEditTextName.getText().toString().trim().length() > 1) {
            if (mEditTextPhone.getSelectionEnd() == 11) {
                if (mEditTextrgencyName.getText().toString().trim().length() > 1) {
                    if (mEditTextUrgencyPhone.getSelectionEnd() == 11) {
                        if (mTextViewRelation.getText().toString().length() > 0) {
                            mButtonSubmit.setEnabled(true);
                        }
                    } else {
                        mButtonSubmit.setEnabled(false);
                    }
                } else {
                    mButtonSubmit.setEnabled(false);
                }
            } else {
                mButtonSubmit.setEnabled(false);
            }
        } else {
            mButtonSubmit.setEnabled(false);
        }
    }
}
